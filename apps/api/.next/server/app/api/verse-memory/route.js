"use strict";(()=>{var e={};e.id=842,e.ids=[842],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},1808:e=>{e.exports=require("net")},2037:e=>{e.exports=require("os")},4074:e=>{e.exports=require("perf_hooks")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},3793:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>N,patchFetch:()=>h,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g});var s={};t.r(s),t.d(s,{GET:()=>m,POST:()=>c});var a=t(9303),o=t(8716),n=t(670),i=t(7070),u=t(469),d=t(3887),l=t(9900),p=t(6103);async function m(e){let r=await (0,p.mU)(e);if(!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,p.yI)(e);if(!t)return i.NextResponse.json({verses:[]});let s=new Date,a=s.getMonth()+1,o=s.getFullYear(),n=await u.db.select().from(d.verseMemory).where((0,l.xD)((0,l.eq)(d.verseMemory.groupId,t),(0,l.eq)(d.verseMemory.month,a),(0,l.eq)(d.verseMemory.year,o))),m=await Promise.all(n.map(async e=>{let t=await u.db.query.verseMemoryProgress.findFirst({where:(0,l.xD)((0,l.eq)(d.verseMemoryProgress.verseId,e.id),(0,l.eq)(d.verseMemoryProgress.userId,r.id))});return{id:e.id,verseReference:e.verseReference,verseSnippet:e.verseSnippet,month:e.month,year:e.year,memorized:t?.memorized??!1}}));return i.NextResponse.json({verses:m})}async function c(e){try{await (0,p.kF)(e)}catch(e){if(e instanceof Response)return e;throw e}let r=await (0,p.yI)(e);if(!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{verseReference:t,verseSnippet:s}=await e.json();if(!t||!t.trim())return i.NextResponse.json({error:"verseReference is required"},{status:400});let a=new Date,o=a.getMonth()+1,n=a.getFullYear(),m=await u.db.query.verseMemory.findFirst({where:(0,l.xD)((0,l.eq)(d.verseMemory.groupId,r),(0,l.eq)(d.verseMemory.month,o),(0,l.eq)(d.verseMemory.year,n))});if(m){let[e]=await u.db.update(d.verseMemory).set({verseReference:t.trim(),verseSnippet:s?.trim()??null}).where((0,l.eq)(d.verseMemory.id,m.id)).returning();return i.NextResponse.json({verse:e})}let[c]=await u.db.insert(d.verseMemory).values({groupId:r,verseReference:t.trim(),verseSnippet:s?.trim()??null,month:o,year:n}).returning();return i.NextResponse.json({verse:c})}let f=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/verse-memory/route",pathname:"/api/verse-memory",filename:"route",bundlePath:"app/api/verse-memory/route"},resolvedPagePath:"/Users/dan/Documents/Dev/smallgroup/apps/api/src/app/api/verse-memory/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:v}=f,N="/api/verse-memory/route";function h(){return(0,n.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}},469:(e,r,t)=>{t.d(r,{db:()=>u});var s=t(3039),a=t(6129),o=t(3887);let n=process.env.DATABASE_URL,i=(0,a.Z)(n,{max:10}),u=(0,s.t)(i,{schema:o})},3887:(e,r,t)=>{t.r(r),t.d(r,{announcements:()=>g,announcementsRelations:()=>A,discussionTopics:()=>h,discussionTopicsRelations:()=>x,groupMembers:()=>y,groupMembersRelations:()=>j,groups:()=>f,groupsRelations:()=>q,prayerRequests:()=>_,prayerRequestsRelations:()=>D,roleEnum:()=>m,snackSignups:()=>N,snackSignupsRelations:()=>I,snackSlots:()=>v,snackSlotsRelations:()=>M,users:()=>c,usersRelations:()=>R,verseMemory:()=>w,verseMemoryProgress:()=>b,verseMemoryProgressRelations:()=>V,verseMemoryRelations:()=>L});var s=t(268),a=t(5735),o=t(1107),n=t(7726),i=t(4192),u=t(8064),d=t(9488),l=t(3238),p=t(4704);let m=(0,s.ys)("role",["admin","member"]),c=(0,a.af)("users",{id:(0,o.Vj)("id").primaryKey(),authId:(0,n.fL)("auth_id").notNull().unique(),email:(0,n.fL)("email").notNull(),displayName:(0,n.fL)("display_name"),birthdayMonth:(0,i._L)("birthday_month"),birthdayDay:(0,i._L)("birthday_day"),createdAt:(0,u.AB)("created_at").defaultNow().notNull(),updatedAt:(0,u.AB)("updated_at").defaultNow().notNull()}),f=(0,a.af)("groups",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),name:(0,n.fL)("name").notNull(),createdAt:(0,u.AB)("created_at").defaultNow().notNull()}),y=(0,a.af)("group_members",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),userId:(0,o.Vj)("user_id").notNull().references(()=>c.id,{onDelete:"cascade"}),role:m("role").notNull().default("member"),joinedAt:(0,u.AB)("joined_at").defaultNow().notNull()}),g=(0,a.af)("announcements",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),authorId:(0,o.Vj)("author_id").notNull().references(()=>c.id,{onDelete:"cascade"}),title:(0,n.fL)("title").notNull(),body:(0,n.fL)("body").notNull(),link:(0,n.fL)("link"),createdAt:(0,u.AB)("created_at").defaultNow().notNull()}),v=(0,a.af)("snack_slots",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),slotDate:(0,d.hT)("slot_date").notNull(),createdAt:(0,u.AB)("created_at").defaultNow().notNull()}),N=(0,a.af)("snack_signups",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),slotId:(0,o.Vj)("slot_id").notNull().references(()=>v.id,{onDelete:"cascade"}),userId:(0,o.Vj)("user_id").notNull().references(()=>c.id,{onDelete:"cascade"}),createdAt:(0,u.AB)("created_at").defaultNow().notNull()}),h=(0,a.af)("discussion_topics",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),title:(0,n.fL)("title").notNull(),description:(0,n.fL)("description"),bibleReference:(0,n.fL)("bible_reference"),bibleText:(0,n.fL)("bible_text"),month:(0,i._L)("month").notNull(),year:(0,i._L)("year").notNull(),createdAt:(0,u.AB)("created_at").defaultNow().notNull(),updatedAt:(0,u.AB)("updated_at").defaultNow().notNull()}),_=(0,a.af)("prayer_requests",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),authorId:(0,o.Vj)("author_id").notNull().references(()=>c.id,{onDelete:"cascade"}),content:(0,n.fL)("content").notNull(),isPrivate:(0,l.O7)("is_private").default(!1),prayed:(0,l.O7)("prayed").default(!1),createdAt:(0,u.AB)("created_at").defaultNow().notNull()}),w=(0,a.af)("verse_memory",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),verseReference:(0,n.fL)("verse_reference").notNull(),verseSnippet:(0,n.fL)("verse_snippet"),month:(0,i._L)("month").notNull(),year:(0,i._L)("year").notNull(),createdAt:(0,u.AB)("created_at").defaultNow().notNull()}),b=(0,a.af)("verse_memory_progress",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),verseId:(0,o.Vj)("verse_id").notNull().references(()=>w.id,{onDelete:"cascade"}),userId:(0,o.Vj)("user_id").notNull().references(()=>c.id,{onDelete:"cascade"}),memorized:(0,l.O7)("memorized").default(!1),updatedAt:(0,u.AB)("updated_at").defaultNow().notNull()}),R=(0,p.lE)(c,({many:e})=>({groupMembers:e(y),announcements:e(g),snackSignups:e(N),prayerRequests:e(_),verseMemoryProgress:e(b)})),q=(0,p.lE)(f,({many:e})=>({groupMembers:e(y),announcements:e(g),snackSlots:e(v),discussionTopics:e(h),prayerRequests:e(_),verseMemory:e(w)})),j=(0,p.lE)(y,({one:e})=>({group:e(f),user:e(c)})),A=(0,p.lE)(g,({one:e})=>({group:e(f),author:e(c)})),M=(0,p.lE)(v,({one:e,many:r})=>({group:e(f),signups:r(N)})),I=(0,p.lE)(N,({one:e})=>({slot:e(v),user:e(c)})),x=(0,p.lE)(h,({one:e})=>({group:e(f)})),D=(0,p.lE)(_,({one:e})=>({group:e(f),author:e(c)})),L=(0,p.lE)(w,({one:e,many:r})=>({group:e(f),progress:r(b)})),V=(0,p.lE)(b,({one:e})=>({verse:e(w),user:e(c)}))},6103:(e,r,t)=>{t.d(r,{yI:()=>m,mU:()=>p,kF:()=>c,p:()=>f});var s=t(5064);let a=process.env.NEXT_PUBLIC_SUPABASE_URL,o=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;var n=t(469),i=t(3887),u=t(9900),d=t(6113);let l="Small Group";async function p(e){let r=function(e){let r=e.headers.get("authorization");return r?.startsWith("Bearer ")&&r.slice(7).trim()||null}(e);if(!r)return null;let t=(0,s.eI)(a,o,{global:r?{headers:{Authorization:`Bearer ${r}`}}:void 0}),{data:{user:p},error:m}=await t.auth.getUser(r);if(m||!p)return null;let c=p.id,f=p.email??"",y=p.user_metadata?.full_name??p.user_metadata?.name??p.email??"Member",g=await n.db.query.users.findFirst({where:(0,u.eq)(i.users.authId,c)});if(g)return await n.db.update(i.users).set({email:f,displayName:y||g.displayName,updatedAt:new Date}).where((0,u.eq)(i.users.id,g.id)),await n.db.query.users.findFirst({where:(0,u.eq)(i.users.id,g.id)})??g;let v=await n.db.query.groups.findFirst({where:(0,u.eq)(i.groups.name,l)});if(!v){let[e]=await n.db.insert(i.groups).values({id:(0,d.randomUUID)(),name:l}).returning();v=e}let N=(0,d.randomUUID)();await n.db.insert(i.users).values({id:N,authId:c,email:f,displayName:y||"Member"});let h=0===(await n.db.select().from(i.groupMembers).where((0,u.eq)(i.groupMembers.groupId,v.id))).length;return await n.db.insert(i.groupMembers).values({groupId:v.id,userId:N,role:h?"admin":"member"}),await n.db.query.users.findFirst({where:(0,u.eq)(i.users.id,N)})??null}async function m(e){let r=await p(e);if(!r)return null;let t=await n.db.query.groupMembers.findFirst({where:(0,u.eq)(i.groupMembers.userId,r.id),columns:{groupId:!0}});return t?.groupId??null}async function c(e){let r=await f(e),t=await n.db.query.groupMembers.findFirst({where:(0,u.eq)(i.groupMembers.userId,r.id),columns:{role:!0}});if(t?.role!=="admin")throw new Response(JSON.stringify({error:"Forbidden"}),{status:403,headers:{"Content-Type":"application/json"}});return r}async function f(e){let r=await p(e);if(!r)throw new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});return r}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,584],()=>t(3793));module.exports=s})();