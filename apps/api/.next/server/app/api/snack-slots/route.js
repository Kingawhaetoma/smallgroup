"use strict";(()=>{var e={};e.id=225,e.ids=[225],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},7147:e=>{e.exports=require("fs")},1808:e=>{e.exports=require("net")},2037:e=>{e.exports=require("os")},4074:e=>{e.exports=require("perf_hooks")},2781:e=>{e.exports=require("stream")},4404:e=>{e.exports=require("tls")},2107:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>h,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>N,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{GET:()=>m});var a=r(9303),o=r(8716),n=r(670),l=r(7070),i=r(469),u=r(3887),d=r(9900),p=r(4366),c=r(6103);async function m(e){if(!await (0,c.mU)(e))return l.NextResponse.json({error:"Unauthorized"},{status:401});let t=await (0,c.yI)(e);if(!t)return l.NextResponse.json({slots:[]});let r=new Date().toISOString().slice(0,10),s=await i.db.select().from(u.snackSlots).where((0,d.eq)(u.snackSlots.groupId,t)).orderBy((0,p.d)(u.snackSlots.slotDate));if(s.length<8){let e=new Set(s.map(e=>e.slotDate));for(let a of(function(e){let t=[],r=new Date;r.setHours(0,0,0,0);for(let e=0;e<12;e++)t.push(r.toISOString().slice(0,10)),r.setDate(r.getDate()+7);return t})(0).filter(t=>t>=r&&!e.has(t)).slice(0,8-s.length))await i.db.insert(u.snackSlots).values({groupId:t,slotDate:a});s=await i.db.select().from(u.snackSlots).where((0,d.eq)(u.snackSlots.groupId,t)).orderBy((0,p.d)(u.snackSlots.slotDate))}let a=await Promise.all(s.map(async e=>{let t=await i.db.select({id:u.users.id,displayName:u.users.displayName,email:u.users.email}).from(u.snackSignups).innerJoin(u.users,(0,d.eq)(u.snackSignups.userId,u.users.id)).where((0,d.eq)(u.snackSignups.slotId,e.id));return{id:e.id,slotDate:e.slotDate,signups:t}}));return l.NextResponse.json({slots:a.filter(e=>e.slotDate>=r).slice(0,8)})}let f=new a.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/snack-slots/route",pathname:"/api/snack-slots",filename:"route",bundlePath:"app/api/snack-slots/route"},resolvedPagePath:"/Users/dan/Documents/Dev/smallgroup/apps/api/src/app/api/snack-slots/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:N}=f,_="/api/snack-slots/route";function h(){return(0,n.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:g})}},469:(e,t,r)=>{r.d(t,{db:()=>i});var s=r(3039),a=r(6129),o=r(3887);let n=process.env.DATABASE_URL,l=(0,a.Z)(n,{max:10}),i=(0,s.t)(l,{schema:o})},3887:(e,t,r)=>{r.r(t),r.d(t,{announcements:()=>g,announcementsRelations:()=>I,discussionTopics:()=>h,discussionTopicsRelations:()=>D,groupMembers:()=>y,groupMembersRelations:()=>R,groups:()=>f,groupsRelations:()=>q,prayerRequests:()=>w,prayerRequestsRelations:()=>k,roleEnum:()=>c,snackSignups:()=>_,snackSignupsRelations:()=>S,snackSlots:()=>N,snackSlotsRelations:()=>j,users:()=>m,usersRelations:()=>A,verseMemory:()=>b,verseMemoryProgress:()=>v,verseMemoryProgressRelations:()=>V,verseMemoryRelations:()=>L});var s=r(268),a=r(5735),o=r(1107),n=r(7726),l=r(4192),i=r(8064),u=r(9488),d=r(3238),p=r(4704);let c=(0,s.ys)("role",["admin","member"]),m=(0,a.af)("users",{id:(0,o.Vj)("id").primaryKey(),authId:(0,n.fL)("auth_id").notNull().unique(),email:(0,n.fL)("email").notNull(),displayName:(0,n.fL)("display_name"),birthdayMonth:(0,l._L)("birthday_month"),birthdayDay:(0,l._L)("birthday_day"),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),f=(0,a.af)("groups",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),name:(0,n.fL)("name").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull()}),y=(0,a.af)("group_members",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),userId:(0,o.Vj)("user_id").notNull().references(()=>m.id,{onDelete:"cascade"}),role:c("role").notNull().default("member"),joinedAt:(0,i.AB)("joined_at").defaultNow().notNull()}),g=(0,a.af)("announcements",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),authorId:(0,o.Vj)("author_id").notNull().references(()=>m.id,{onDelete:"cascade"}),title:(0,n.fL)("title").notNull(),body:(0,n.fL)("body").notNull(),link:(0,n.fL)("link"),createdAt:(0,i.AB)("created_at").defaultNow().notNull()}),N=(0,a.af)("snack_slots",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),slotDate:(0,u.hT)("slot_date").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull()}),_=(0,a.af)("snack_signups",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),slotId:(0,o.Vj)("slot_id").notNull().references(()=>N.id,{onDelete:"cascade"}),userId:(0,o.Vj)("user_id").notNull().references(()=>m.id,{onDelete:"cascade"}),createdAt:(0,i.AB)("created_at").defaultNow().notNull()}),h=(0,a.af)("discussion_topics",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),title:(0,n.fL)("title").notNull(),description:(0,n.fL)("description"),bibleReference:(0,n.fL)("bible_reference"),bibleText:(0,n.fL)("bible_text"),month:(0,l._L)("month").notNull(),year:(0,l._L)("year").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull(),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),w=(0,a.af)("prayer_requests",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),authorId:(0,o.Vj)("author_id").notNull().references(()=>m.id,{onDelete:"cascade"}),content:(0,n.fL)("content").notNull(),isPrivate:(0,d.O7)("is_private").default(!1),prayed:(0,d.O7)("prayed").default(!1),createdAt:(0,i.AB)("created_at").defaultNow().notNull()}),b=(0,a.af)("verse_memory",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),groupId:(0,o.Vj)("group_id").notNull().references(()=>f.id,{onDelete:"cascade"}),verseReference:(0,n.fL)("verse_reference").notNull(),verseSnippet:(0,n.fL)("verse_snippet"),month:(0,l._L)("month").notNull(),year:(0,l._L)("year").notNull(),createdAt:(0,i.AB)("created_at").defaultNow().notNull()}),v=(0,a.af)("verse_memory_progress",{id:(0,o.Vj)("id").primaryKey().defaultRandom(),verseId:(0,o.Vj)("verse_id").notNull().references(()=>b.id,{onDelete:"cascade"}),userId:(0,o.Vj)("user_id").notNull().references(()=>m.id,{onDelete:"cascade"}),memorized:(0,d.O7)("memorized").default(!1),updatedAt:(0,i.AB)("updated_at").defaultNow().notNull()}),A=(0,p.lE)(m,({many:e})=>({groupMembers:e(y),announcements:e(g),snackSignups:e(_),prayerRequests:e(w),verseMemoryProgress:e(v)})),q=(0,p.lE)(f,({many:e})=>({groupMembers:e(y),announcements:e(g),snackSlots:e(N),discussionTopics:e(h),prayerRequests:e(w),verseMemory:e(b)})),R=(0,p.lE)(y,({one:e})=>({group:e(f),user:e(m)})),I=(0,p.lE)(g,({one:e})=>({group:e(f),author:e(m)})),j=(0,p.lE)(N,({one:e,many:t})=>({group:e(f),signups:t(_)})),S=(0,p.lE)(_,({one:e})=>({slot:e(N),user:e(m)})),D=(0,p.lE)(h,({one:e})=>({group:e(f)})),k=(0,p.lE)(w,({one:e})=>({group:e(f),author:e(m)})),L=(0,p.lE)(b,({one:e,many:t})=>({group:e(f),progress:t(v)})),V=(0,p.lE)(v,({one:e})=>({verse:e(b),user:e(m)}))},6103:(e,t,r)=>{r.d(t,{yI:()=>c,mU:()=>p,kF:()=>m,p:()=>f});var s=r(5064);let a=process.env.NEXT_PUBLIC_SUPABASE_URL,o=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;var n=r(469),l=r(3887),i=r(9900),u=r(6113);let d="Small Group";async function p(e){let t=function(e){let t=e.headers.get("authorization");return t?.startsWith("Bearer ")&&t.slice(7).trim()||null}(e);if(!t)return null;let r=(0,s.eI)(a,o,{global:t?{headers:{Authorization:`Bearer ${t}`}}:void 0}),{data:{user:p},error:c}=await r.auth.getUser(t);if(c||!p)return null;let m=p.id,f=p.email??"",y=p.user_metadata?.full_name??p.user_metadata?.name??p.email??"Member",g=await n.db.query.users.findFirst({where:(0,i.eq)(l.users.authId,m)});if(g)return await n.db.update(l.users).set({email:f,displayName:y||g.displayName,updatedAt:new Date}).where((0,i.eq)(l.users.id,g.id)),await n.db.query.users.findFirst({where:(0,i.eq)(l.users.id,g.id)})??g;let N=await n.db.query.groups.findFirst({where:(0,i.eq)(l.groups.name,d)});if(!N){let[e]=await n.db.insert(l.groups).values({id:(0,u.randomUUID)(),name:d}).returning();N=e}let _=(0,u.randomUUID)();await n.db.insert(l.users).values({id:_,authId:m,email:f,displayName:y||"Member"});let h=0===(await n.db.select().from(l.groupMembers).where((0,i.eq)(l.groupMembers.groupId,N.id))).length;return await n.db.insert(l.groupMembers).values({groupId:N.id,userId:_,role:h?"admin":"member"}),await n.db.query.users.findFirst({where:(0,i.eq)(l.users.id,_)})??null}async function c(e){let t=await p(e);if(!t)return null;let r=await n.db.query.groupMembers.findFirst({where:(0,i.eq)(l.groupMembers.userId,t.id),columns:{groupId:!0}});return r?.groupId??null}async function m(e){let t=await f(e),r=await n.db.query.groupMembers.findFirst({where:(0,i.eq)(l.groupMembers.userId,t.id),columns:{role:!0}});if(r?.role!=="admin")throw new Response(JSON.stringify({error:"Forbidden"}),{status:403,headers:{"Content-Type":"application/json"}});return t}async function f(e){let t=await p(e);if(!t)throw new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}});return t}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[948,584],()=>r(2107));module.exports=s})();